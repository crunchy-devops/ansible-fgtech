---
version: 3

images:
  base_image:
    name: almalinux:9

dependencies:
  # üö® NOUVEAU : Installer ansible-core et ansible-runner ici,
  # non plus via 'RUN pip3 install...' dans prepend_base.
  ansible_core:
    package_pip: ansible-core  # Installera la derni√®re version stable
  ansible_runner:
    package_pip: ansible-runner

  # Les d√©pendances Python (tox, molecule) passent par requirements.txt
  python: requirements.txt

  # Les d√©pendances syst√®me requises par la compilation Python passent par bindep.txt
  system: bindep.txt

  # Collections Ansible
  galaxy: requirements.yml

additional_build_steps:

  # A. √âtapes avant l'installation des d√©pendances (Paquets Syst√®me et PATH)
  prepend_base:
    # 1. Installation des outils syst√®me (pip, compilation)
    - RUN dnf -y update && dnf install -y python3-pip python3-devel gcc git tar unzip && dnf clean all

    # 2. Ajuster le PATH pour que 'ansible' soit trouv√© apr√®s son installation par le builder
    - ENV PATH="/usr/local/bin:$PATH"

  # B. Cr√©ation de l'utilisateur AWX (UID 1000)
  prepend:
    - RUN groupadd -g 1000 awx
    - RUN useradd -u 1000 -g awx -m -s /bin/bash awx
    - RUN mkdir -p /opt/app-root/src && chown 1000:1000 /opt/app-root/src

  # C. Finalisation
  append:
    - USER awx
    - WORKDIR /opt/app-root/src